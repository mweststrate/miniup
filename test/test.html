<!DOCTYPE HTML>
<html>
<head>
	<script src="../miniup.js"></script>
	<script src="../lib/jquery-1.7.1.min.js"></script>
</head>
<body>
	<input type="button" value="Parse!" id="parse" />
	<table width="100%">
		<tr>
			<td width="50%"><textarea id="grammar" rows="20">x = x 'a' / 'a'</textarea></td>
			<td><textarea id="input" rows="20">aaa</textarea></td>
		</tr>
		<tr>
			<td>
				<form id="opts">
					<label for="startSymbol">startSymbol</label>
					<input type="input" id="startSymbol"><br/>
					<input type="checkbox" value="true" checked id="debug">
					<label for="debug">debug</label></br/>
					<input type="checkbox" value="true" id="cleanAST">
					<label for="cleanAST">cleanAST</label></br/>
					<input type="checkbox" value="true" id="extendedAST">
					<label for="extendedAST">extendedAST</label></br/>
					<input type="checkbox" value="true" checked id="allowLeftRecursion">
					<label for="allowLeftRecursion">allowLeftRecursion</label></br/>
					<input type="checkbox" value="true" checked id="optimize">
					<label for="optimize">optimize</label></br/>
				</form>
			</td>
		</tr>

	</table>
	<div id="output"></div>
	<script type="text/javascript">
		function escapeHTML(text) {
			return $('<div/>').text(text).html();
		}

		function renderData(data, node) {
			if (typeof data == "object") {
				var elem = $("<div><span class='expander'>+</span><table class='data'></table></div>").appendTo(node);
				var table = $("table", elem).appendTo(node);
				for(var key in data) {
					var td = $("<td>").appendTo($("<tr><td>" + escapeHTML(key) + "</td></tr>", {
						'class' : key.match(/^\$/) ? "builtin-attr" : key.match(/^\d+$/) ? "builtin-attr" : "attr"
					}).appendTo(table));
					renderData(data[key], td);
				}
			}
			else if (typeof data == "array") {
				var elem = $("<div><span class='expander'>+</span><table class='data'></table></div>").appendTo(node);
				var table = $("table", elem).appendTo(node);
				for(var i = 0; i< data.length; i++) {
					var td = $("<td>").appendTo($("<tr><td class='table-index'>" + i + "</td></tr>").appendTo(table));
					renderData(data[i], td);
				}
			}
			else
				$("<span class='text'/>").text(data).appendTo(node);
		}

		$('#parse').on('click', function() {
			//var g = miniup.GrammarReader.getMiniupGrammar();
			//var r = g.parse($('#grammar').val());
			//$('#input').val(JSON.stringify(r));
			//console.dir(r);
			var params = {};
			$("#opts input").map(function() {
				var elem = $(this);
				params[elem.attr('id')] = (elem.attr('type') == 'checkbox') ? elem.attr('checked') == 'checked' : elem.attr('value');
			});
			try {
				var g = miniup.Grammar.load($('#grammar').val());
				var data = g.parse($('#input').val(), params);
				renderData(data, $('#output'));
			}
			catch (e) {
				$('#output').html(escapeHTML(e.name + ":\n\n" + e.message).replace(/\n/gi, "<br/>"));
			}
		})
	</script>
</body>